{% extends "base.html" %}

{% block title %}Corrector de Código - Codestorm Assistant{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Corrector Automático de Código</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Este corrector automático analiza tu código, corrige errores de sintaxis y mejora la calidad siguiendo buenas prácticas.
                    </div>

                    <div class="mb-3">
                        <label for="code-language" class="form-label">Lenguaje</label>
                        <select class="form-select" id="code-language">
                            <option value="python" selected>Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="typescript">TypeScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="csharp">C#</option>
                            <option value="php">PHP</option>
                            <option value="ruby">Ruby</option>
                            <option value="go">Go</option>
                            <option value="swift">Swift</option>
                            <option value="kotlin">Kotlin</option>
                            <option value="rust">Rust</option>
                            <option value="html">HTML</option>
                            <option value="css">CSS</option>
                            <option value="sql">SQL</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="code-input" class="form-label">Código a corregir</label>
                        <textarea class="form-control code-editor" id="code-input" rows="10" placeholder="Pega aquí tu código..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="instructions" class="form-label">Instrucciones (opcional)</label>
                        <textarea class="form-control" id="instructions" rows="2" placeholder="Instrucciones específicas para la corrección..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="model-select" class="form-label">Modelo de IA</label>
                        <select class="form-select" id="model-select">
                            <option value="openai" selected>OpenAI (GPT-4)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="gemini">Google (Gemini)</option>
                        </select>
                        <div id="api-status" class="mt-2 small text-info">Verificando disponibilidad de modelos...</div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="auto-fix" checked>
                        <label class="form-check-label" for="auto-fix">
                            Corrección automática (corregir errores comunes sin alterar la funcionalidad)
                        </label>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="process-btn">
                            <i class="bi bi-wrench"></i> Corregir código
                        </button>
                        <button class="btn btn-outline-secondary" id="debug-btn">
                            <i class="bi bi-bug"></i> Depurador automático
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4" id="results-container" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Resultados</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" id="copy-btn">
                            <i class="bi bi-clipboard"></i> Copiar
                        </button>
                        <button class="btn btn-sm btn-outline-success me-2" id="download-btn">
                            <i class="bi bi-download"></i> Descargar
                        </button>
                        <button class="btn btn-sm btn-outline-info" id="apply-fix-btn">
                            <i class="bi bi-magic"></i> Aplicar corrección
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="result-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="code-tab" data-bs-toggle="tab" data-bs-target="#code-content" type="button" role="tab" aria-controls="code-content" aria-selected="true">Código corregido</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="diff-tab" data-bs-toggle="tab" data-bs-target="#diff-content" type="button" role="tab" aria-controls="diff-content" aria-selected="false">Diferencias</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="changes-tab" data-bs-toggle="tab" data-bs-target="#changes-content" type="button" role="tab" aria-controls="changes-content" aria-selected="false">Cambios</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="explanation-tab" data-bs-toggle="tab" data-bs-target="#explanation-content" type="button" role="tab" aria-controls="explanation-content" aria-selected="false">Explicación</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="result-tabs-content">
                        <div class="tab-pane fade show active" id="code-content" role="tabpanel" aria-labelledby="code-tab">
                            <pre><code id="corrected-code" class="language-python"></code></pre>
                        </div>
                        <div class="tab-pane fade" id="diff-content" role="tabpanel" aria-labelledby="diff-tab">
                            <pre><code id="diff-view" class="language-diff"></code></pre>
                        </div>
                        <div class="tab-pane fade" id="changes-content" role="tabpanel" aria-labelledby="changes-tab">
                            <div id="changes-list" class="list-group">
                                <!-- Los cambios se listarán aquí dinámicamente -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="explanation-content" role="tabpanel" aria-labelledby="explanation-tab">
                            <div id="explanation-text" class="markdown-content">
                                <!-- La explicación se mostrará aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Debugger -->
<div class="modal fade" id="debug-modal" tabindex="-1" aria-labelledby="debug-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="debug-modal-label">Depurador Automático</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="error-message" class="form-label">Mensaje de error (opcional)</label>
                    <textarea class="form-control" id="error-message" rows="3" placeholder="Pega aquí el mensaje de error..."></textarea>
                </div>
                <div class="progress mb-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="debug-result" class="border p-3 rounded bg-light" style="display: none;">
                    <h6>Diagnóstico:</h6>
                    <div id="debug-diagnosis" class="mb-3"></div>
                    <h6>Solución propuesta:</h6>
                    <pre><code id="debug-fix" class="language-python"></code></pre>
                    <div class="d-flex justify-content-end mt-3">
                        <button id="apply-debug-fix" class="btn btn-sm btn-success">Aplicar solución</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="start-debug">Iniciar depuración</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/diff/5.1.0/diff.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.getElementById('code-input');
    const codeLanguage = document.getElementById('code-language');
    const instructions = document.getElementById('instructions');
    const modelSelect = document.getElementById('model-select');
    const autoFix = document.getElementById('auto-fix');
    const processBtn = document.getElementById('process-btn');
    const debugBtn = document.getElementById('debug-btn');
    const resultsContainer = document.getElementById('results-container');
    const correctedCode = document.getElementById('corrected-code');
    const diffView = document.getElementById('diff-view');
    const changesList = document.getElementById('changes-list');
    const explanationText = document.getElementById('explanation-text');
    const copyBtn = document.getElementById('copy-btn');
    const downloadBtn = document.getElementById('download-btn');
    const applyFixBtn = document.getElementById('apply-fix-btn');

    // Debug modal elements
    const debugModal = new bootstrap.Modal(document.getElementById('debug-modal'));
    const errorMessage = document.getElementById('error-message');
    const startDebugBtn = document.getElementById('start-debug');
    const debugResult = document.getElementById('debug-result');
    const debugDiagnosis = document.getElementById('debug-diagnosis');
    const debugFix = document.getElementById('debug-fix');
    const applyDebugFixBtn = document.getElementById('apply-debug-fix');
    const progressBar = document.querySelector('.progress');
    const progressBarInner = document.querySelector('.progress-bar');

    // Verificar disponibilidad de modelos
    fetch('/api/health')
        .then(response => response.json())
        .then(data => {
            const apiStatus = document.getElementById('api-status');
            const apis = data.apis || {};

            for (const [model, status] of Object.entries(apis)) {
                const option = modelSelect.querySelector(`option[value="${model}"]`);
                if (option) {
                    if (status !== 'ok') {
                        option.disabled = true;
                        option.textContent += ' (no configurado)';
                    }
                }
            }

            // Seleccionar el primer modelo disponible
            const firstEnabled = Array.from(modelSelect.options).find(opt => !opt.disabled);
            if (firstEnabled) {
                firstEnabled.selected = true;
            }

            const availableModels = Object.entries(apis)
                .filter(([_, status]) => status === 'ok')
                .map(([name, _]) => name);

            if (availableModels.length > 0) {
                apiStatus.textContent = 'Modelos disponibles: ' + availableModels.join(', ');
                apiStatus.className = 'mt-2 small text-success';
            } else {
                apiStatus.textContent = 'No hay modelos configurados. Configura una API en el panel de Secrets.';
                apiStatus.className = 'mt-2 small text-warning';
            }
        })
        .catch(error => {
            console.error('Error al verificar APIs:', error);
            const apiStatus = document.getElementById('api-status');
            apiStatus.textContent = 'Error al verificar disponibilidad de APIs';
            apiStatus.className = 'mt-2 small text-danger';
        });

    // Función para generar diff
    function generateDiff(original, corrected) {
        if (!original || !corrected) return '';

        const diffLines = Diff.diffLines(original, corrected);
        let diffResult = '';

        diffLines.forEach(part => {
            // Marcar las líneas como agregadas, removidas o iguales
            const prefix = part.added ? '+' : part.removed ? '-' : ' ';
            const color = part.added ? 'green' : part.removed ? 'red' : 'grey';

            // Dividir en líneas y agregar el prefijo
            const lines = part.value.split('\n').filter(line => line.length > 0);
            lines.forEach(line => {
                diffResult += `<span style="color: ${color}">${prefix} ${line}</span>\n`;
            });
        });

        return diffResult;
    }

    // Procesar código
    processBtn.addEventListener('click', function() {
        const code = codeInput.value.trim();
        const language = codeLanguage.value;
        const instructionsText = instructions.value.trim();
        const model = modelSelect.value;
        const isAutoFix = autoFix.checked;

        if (!code) {
            alert('Por favor, ingresa código para corregir');
            return;
        }

        // Mostrar estado de carga
        processBtn.disabled = true;
        processBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
        resultsContainer.style.display = 'none';

        // Enviar al servidor para procesar
        fetch('/api/process_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                code: code,
                language: language,
                instructions: instructionsText || 'Corrige errores y mejora la calidad del código',
                model: model,
                auto_fix: isAutoFix
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error en el servidor: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido al procesar el código');
            }

            // Actualizar resultados
            correctedCode.textContent = data.corrected_code;
            correctedCode.className = `language-${language}`;

            // Generar y mostrar diff
            diffView.innerHTML = generateDiff(code, data.corrected_code);
            diffView.className = 'language-diff';

            // Resaltar código
            hljs.highlightElement(correctedCode);
            hljs.highlightElement(diffView);

            // Mostrar cambios
            changesList.innerHTML = '';
            if (data.changes && data.changes.length > 0) {
                data.changes.forEach(change => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';

                    const lineInfo = change.lineNumbers ? 
                        `<span class="badge bg-secondary">Línea(s): ${change.lineNumbers.join(', ')}</span>` : '';

                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>${change.description}</div>
                            ${lineInfo}
                        </div>
                    `;

                    changesList.appendChild(item);
                });
            } else {
                changesList.innerHTML = '<div class="list-group-item">No se detectaron cambios significativos</div>';
            }

            // Mostrar explicación
            explanationText.innerHTML = marked.parse(data.explanation || 'No se proporcionó una explicación detallada.');

            // Mostrar resultados
            resultsContainer.style.display = 'block';

            // Desplazarse a los resultados
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error al procesar el código: ${error.message}`);
        })
        .finally(() => {
            // Restaurar botón
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="bi bi-wrench"></i> Corregir código';
        });
    });

    // Abrir modal de depuración
    debugBtn.addEventListener('click', function() {
        errorMessage.value = '';
        debugResult.style.display = 'none';
        progressBar.style.display = 'none';
        progressBarInner.style.width = '0%';
        debugModal.show();
    });

    // Iniciar depuración
    startDebugBtn.addEventListener('click', function() {
        const code = codeInput.value.trim();
        const language = codeLanguage.value;
        const error = errorMessage.value.trim();

        if (!code) {
            alert('Por favor, ingresa código para depurar');
            return;
        }

        // Mostrar barra de progreso
        progressBar.style.display = 'block';
        debugResult.style.display = 'none';
        startDebugBtn.disabled = true;

        // Simulación de progreso (en una aplicación real, esto sería una llamada al backend)
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            progressBarInner.style.width = `${progress}%`;

            if (progress >= 100) {
                clearInterval(interval);

                // Simulación de diagnóstico (en una aplicación real, esto vendría del backend)
                setTimeout(() => {
                    // Análisis automático del código
                    let diagnosis = 'El código contiene posibles problemas de sintaxis.';
                    let fixedCode = code;

                    // Verificar errores comunes según el lenguaje
                    if (language === 'python') {
                        // Ejemplo de corrección para Python
                        if (code.includes('print ')) {
                            // Error común: print sin paréntesis (Python 2 vs 3)
                            diagnosis = 'Se detectó uso de la función print sin paréntesis (estilo Python 2). En Python 3, print es una función y requiere paréntesis.';
                            fixedCode = code.replace(/print\s+([^(].*$)/gm, 'print($1)');
                        } else if (code.includes('except') && code.includes(',')) {
                            // Error común: sintaxis de except antigua
                            diagnosis = 'Se detectó uso de sintaxis antigua para las excepciones. Use "as" en lugar de coma.';
                            fixedCode = code.replace(/except\s+(\w+)\s*,\s*(\w+)/g, 'except $1 as $2');
                        }
                    } else if (language === 'javascript') {
                        // Ejemplo de corrección para JavaScript
                        if (code.includes('var ')) {
                            diagnosis = 'Se recomienda usar "let" o "const" en lugar de "var" para la declaración de variables.';
                            fixedCode = code.replace(/var\s+(\w+)/g, 'let $1');
                        }
                    }

                    // Si hay un mensaje de error, mostrarlo en el diagnóstico
                    if (error) {
                        diagnosis = `Error reportado: ${error}<br><br>${diagnosis}`;
                    }

                    // Mostrar resultados
                    debugDiagnosis.innerHTML = diagnosis;
                    debugFix.textContent = fixedCode;
                    debugFix.className = `language-${language}`;
                    hljs.highlightElement(debugFix);

                    debugResult.style.display = 'block';
                    startDebugBtn.disabled = false;
                }, 1000);
            }
        }, 100);
    });

    // Aplicar corrección de depuración al editor
    applyDebugFixBtn.addEventListener('click', function() {
        codeInput.value = debugFix.textContent;
        debugModal.hide();
    });

    // Copiar código corregido
    copyBtn.addEventListener('click', function() {
        const code = correctedCode.textContent;
        navigator.clipboard.writeText(code)
            .then(() => {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check"></i> Copiado';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            })
            .catch(err => {
                console.error('Error al copiar:', err);
                alert('No se pudo copiar el código');
            });
    });

    // Aplicar corrección al editor
    applyFixBtn.addEventListener('click', function() {
        codeInput.value = correctedCode.textContent;
        resultsContainer.style.display = 'none';

        // Notificar al usuario
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show mt-3';
        notification.innerHTML = `
            Corrección aplicada al editor
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        codeInput.parentNode.insertBefore(notification, codeInput.nextSibling);

        // Desplazarse al editor
        codeInput.scrollIntoView({ behavior: 'smooth' });
        codeInput.focus();

        // Eliminar notificación después de unos segundos
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    });

    // Descargar código corregido
    downloadBtn.addEventListener('click', function() {
        const code = correctedCode.textContent;
        const language = codeLanguage.value;

        // Determinar extensión de archivo según lenguaje
        const extensions = {
            'python': 'py',
            'javascript': 'js',
            'typescript': 'ts',
            'java': 'java',
            'cpp': 'cpp',
            'csharp': 'cs',
            'php': 'php',
            'ruby': 'rb',
            'go': 'go',
            'swift': 'swift',
            'kotlin': 'kt',
            'rust': 'rs',
            'html': 'html',
            'css': 'css',
            'sql': 'sql'
        };

        const extension = extensions[language] || 'txt';
        const filename = `codigo_corregido.${extension}`;

        // Crear blob y descargar
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();

        // Liberar URL
        setTimeout(() => URL.revokeObjectURL(url), 100);
    });

    // Cambiar sintaxis de highlight.js cuando cambia el lenguaje
    codeLanguage.addEventListener('change', function() {
        const language = codeLanguage.value;
        correctedCode.className = `language-${language}`;
        if (correctedCode.textContent) {
            hljs.highlightElement(correctedCode);
        }
    });
});
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<style>
    .code-editor {
        font-family: monospace;
        tab-size: 4;
    }

    pre {
        background-color: #282c34;
        border-radius: 4px;
        padding: 15px;
        margin: 0;
        max-height: 500px;
        overflow-y: auto;
    }

    pre code {
        font-family: 'Source Code Pro', Consolas, Monaco, 'Andale Mono', monospace;
        font-size: 0.9rem;
    }

    .markdown-content {
        line-height: 1.6;
    }

    .markdown-content code {
        background-color: #f0f0f0;
        padding: 2px 4px;
        border-radius: 3px;
    }

    .list-group-item {
        border-left: 3px solid #007bff;
    }

    /* Estilos para el diff */
    #diff-view span {
        display: block;
        white-space: pre-wrap;
        font-family: monospace;
    }

    /* Mejoras visuales */
    .card {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background-color: #0d6efd;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}