<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Archivos - Codestorm Assistant</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #121212;
            color: #e9ecef;
        }

        .main-content {
            flex: 1;
        }

        .file-explorer {
            border: 1px solid #2c3034;
            border-radius: 6px;
            overflow: hidden;
            background-color: #1a1a1a;
        }

        .file-explorer-header {
            background-color: #212529;
            border-bottom: 1px solid #2c3034;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-path {
            font-weight: 500;
            color: #adb5bd;
        }

        .file-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .file-item {
            padding: 8px 15px;
            border-bottom: 1px solid #2c3034;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .file-item:hover {
            background-color: #2c3034;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .directory .file-item-icon {
            color: #ffc107;
        }

        .file .file-item-icon {
            color: #6c757d;
        }

        .file-item-details {
            display: flex;
            margin-left: auto;
            color: #6c757d;
            font-size: 0.85rem;
        }

        .file-size {
            margin-right: 15px;
            min-width: 70px;
            text-align: right;
        }

        .file-date {
            min-width: 150px;
        }

        .file-actions {
            gap: 8px;
            display: flex;
        }

        .breadcrumb-item a {
            color: #6c757d;
            text-decoration: none;
        }

        .breadcrumb-item.active {
            color: #adb5bd;
        }

        .footer {
            margin-top: auto;
            background-color: #212529;
            color: #6c757d;
        }

        /* Context menu styles */
        .file-context-menu {
            background-color: #212529;
            border: 1px solid #2c3034;
            border-radius: 4px;
            padding: 5px 0;
            z-index: 1000;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            color: #e9ecef;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #343a40;
        }

        .context-menu-item i {
            width: 20px;
            text-align: center;
            margin-right: 8px;
        }

        .context-menu-separator {
            height: 1px;
            background-color: #2c3034;
            margin: 5px 0;
        }

        .context-menu-item.danger {
            color: #dc3545;
        }

        .context-menu-item.danger:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-lightning-charge-fill text-warning"></i>
                Codestorm Assistant
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house-door"></i> Inicio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/files">
                            <i class="bi bi-folder"></i> Explorador
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-content my-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>
                        <i class="bi bi-folder-fill text-warning"></i>
                        Explorador de Archivos
                    </h2>
                    <div>
                        <a href="/" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>

                <div class="file-explorer">
                    <div class="file-explorer-header">
                        <div>
                            <span class="file-path" id="directory-path">/</span>
                            <nav aria-label="breadcrumb" class="d-inline-block ms-3">
                                <ol class="breadcrumb mb-0" id="path-breadcrumb">
                                    <li class="breadcrumb-item active">/</li>
                                </ol>
                            </nav>
                        </div>
                        <div id="file-actions">
                            <button class="btn btn-sm btn-outline-primary" id="create-file-btn">
                                <i class="bi bi-file-earmark-plus"></i> Nuevo archivo
                            </button>
                            <button class="btn btn-sm btn-outline-secondary ms-2" id="create-folder-btn">
                                <i class="bi bi-folder-plus"></i> Nueva carpeta
                            </button>
                            <button class="btn btn-sm btn-outline-info ms-2" id="refresh-btn">
                                <i class="bi bi-arrow-repeat"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    <div id="file-explorer-content">
                        <div class="p-4 text-center text-muted">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando archivos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5 py-3 bg-dark">
        <div class="container text-center">
            <span class="text-muted">Codestorm-Assistant © 2025 | AI-Powered Development Tool</span>
        </div>
    </footer>

    <!-- Notification container -->
    <div id="notifications" class="position-fixed top-0 end-0 p-3" style="z-index: 5000;"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/websocket.js') }}"></script>
    <script>
        // Asegurarse de que Bootstrap esté disponible globalmente
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si bootstrap está disponible
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap no está cargado correctamente. Intentando cargar de nuevo...');
                
                // Cargar dinámicamente
                const bootstrapScript = document.createElement('script');
                bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
                bootstrapScript.onload = function() {
                    console.log('Bootstrap cargado dinámicamente');
                };
                document.head.appendChild(bootstrapScript);
            } else {
                console.log('Bootstrap cargado correctamente');
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/file-actions.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const directoryPath = document.getElementById('directory-path');
            const fileExplorerContent = document.getElementById('file-explorer-content');
            const pathBreadcrumb = document.getElementById('path-breadcrumb');
            const createFileBtn = document.getElementById('create-file-btn');
            const createFolderBtn = document.getElementById('create-folder-btn');
            const refreshBtn = document.getElementById('refresh-btn');
            
            let currentDirectory = '/';
            
            // Load initial directory
            loadDirectory(currentDirectory);
            
            // Create file button click event
            createFileBtn.addEventListener('click', function() {
                window.fileActions.createNewFile();
            });
            
            // Create folder button click event
            createFolderBtn.addEventListener('click', function() {
                window.fileActions.createNewFolder();
            });
            
            // Refresh button click event
            refreshBtn.addEventListener('click', function() {
                if (window.fileActions && typeof window.fileActions.refreshFileExplorer === 'function') {
                    window.fileActions.refreshFileExplorer();
                } else {
                    // Fallback to reload if the new function isn't available
                    window.location.reload();
                }
            });
            
            // Function to load directory contents
            function loadDirectory(directory) {
                fetch('/api/list_files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ directory: directory })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    
                    renderFileList(data.files, data.current_dir);
                    updateBreadcrumb(data.current_dir);
                    
                    // Update current directory
                    currentDirectory = data.current_dir;
                    directoryPath.textContent = currentDirectory;
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    showError('Error al cargar archivos: ' + error.message);
                });
            }
            
            // Render file list
            function renderFileList(files, currentDir) {
                const fileList = document.createElement('ul');
                fileList.className = 'file-list';
                
                if (files.length === 0) {
                    fileExplorerContent.innerHTML = `
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-folder-x" style="font-size: 2rem;"></i>
                            <p class="mt-2">Carpeta vacía</p>
                        </div>
                    `;
                    return;
                }
                
                files.forEach(file => {
                    const fileItem = document.createElement('li');
                    fileItem.className = `file-item ${file.type}`;
                    
                    // Icon based on file type
                    let icon = 'bi-file-earmark';
                    if (file.type === 'directory') {
                        icon = file.name === '..' ? 'bi-arrow-up' : 'bi-folder-fill';
                    } else {
                        // Use specific icons based on file extension
                        const extension = file.name.split('.').pop()?.toLowerCase();
                        if (extension === 'js') icon = 'bi-filetype-js';
                        else if (extension === 'html') icon = 'bi-filetype-html';
                        else if (extension === 'css') icon = 'bi-filetype-css';
                        else if (extension === 'py') icon = 'bi-filetype-py';
                        else if (extension === 'json') icon = 'bi-filetype-json';
                        else if (extension === 'md') icon = 'bi-markdown';
                        else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(extension)) icon = 'bi-file-earmark-image';
                    }
                    
                    fileItem.innerHTML = `
                        <i class="bi ${icon} file-item-icon"></i>
                        <span>${file.name}</span>
                        <div class="file-item-details">
                            ${file.type !== 'directory' ? `<span class="file-size">${formatFileSize(file.size)}</span>` : ''}
                            ${file.modified ? `<span class="file-date">${file.modified}</span>` : ''}
                        </div>
                    `;
                    
                    // Click event for files and directories
                    fileItem.addEventListener('click', function(e) {
                        if (file.type === 'directory') {
                            // Navigate to directory
                            if (file.name === '..') {
                                // Go up one level
                                const parentDir = currentDir.split('/').slice(0, -1).join('/') || '/';
                                loadDirectory(parentDir === '/' ? '.' : parentDir);
                            } else {
                                // Go into directory
                                const newPath = currentDir === '/' ? file.name : `${currentDir}/${file.name}`;
                                loadDirectory(newPath);
                            }
                        } else {
                            // Open file in editor
                            const filePath = currentDir === '/' ? file.name : `${currentDir}/${file.name}`;
                            window.location.href = `/edit/${filePath}`;
                        }
                    });
                    
                    fileList.appendChild(fileItem);
                });
                
                fileExplorerContent.innerHTML = '';
                fileExplorerContent.appendChild(fileList);
                
                // Add context menu to file items
                addFileContextMenu();
            }
            
            // Add context menu to file items
            function addFileContextMenu() {
                const fileItems = document.querySelectorAll('.file-item');
                
                fileItems.forEach(item => {
                    item.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        
                        const fileName = item.querySelector('span').textContent;
                        // Don't allow operations on parent directory
                        if (fileName === '..') return;
                        
                        const isDirectory = item.classList.contains('directory');
                        const filePath = currentDirectory === '/' 
                            ? fileName 
                            : `${currentDirectory}/${fileName}`;
                        
                        // Create context menu
                        const menu = document.createElement('div');
                        menu.className = 'file-context-menu position-absolute';
                        menu.style.left = `${e.pageX}px`;
                        menu.style.top = `${e.pageY}px`;
                        
                        // Context menu items
                        if (!isDirectory) {
                            const editItem = document.createElement('div');
                            editItem.className = 'context-menu-item';
                            editItem.innerHTML = '<i class="bi bi-pencil"></i> Editar';
                            editItem.addEventListener('click', () => {
                                window.location.href = `/edit/${filePath}`;
                            });
                            menu.appendChild(editItem);
                        }
                        
                        const deleteItem = document.createElement('div');
                        deleteItem.className = 'context-menu-item danger';
                        deleteItem.innerHTML = '<i class="bi bi-trash"></i> Eliminar';
                        deleteItem.addEventListener('click', () => {
                            window.fileActions.deleteFileOrFolder(filePath);
                        });
                        menu.appendChild(deleteItem);
                        
                        // Add menu to document
                        document.body.appendChild(menu);
                        
                        // Remove menu on click outside
                        const closeMenu = (e) => {
                            if (!menu.contains(e.target)) {
                                menu.remove();
                                document.removeEventListener('click', closeMenu);
                            }
                        };
                        
                        setTimeout(() => {
                            document.addEventListener('click', closeMenu);
                        }, 0);
                    });
                });
            }
            
            // Update breadcrumb navigation
            function updateBreadcrumb(path) {
                // Clear existing breadcrumb
                pathBreadcrumb.innerHTML = '';
                
                // Add root
                const rootLi = document.createElement('li');
                rootLi.className = 'breadcrumb-item';
                
                if (path === '/') {
                    rootLi.classList.add('active');
                    rootLi.textContent = '/';
                } else {
                    const rootLink = document.createElement('a');
                    rootLink.href = '#';
                    rootLink.textContent = '/';
                    rootLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        loadDirectory('.');
                    });
                    rootLi.appendChild(rootLink);
                }
                
                pathBreadcrumb.appendChild(rootLi);
                
                // Add path parts
                if (path !== '/') {
                    const parts = path.split('/');
                    let currentPath = '';
                    
                    parts.forEach((part, index) => {
                        if (!part) return; // Skip empty parts
                        
                        currentPath += part;
                        const li = document.createElement('li');
                        li.className = 'breadcrumb-item';
                        
                        if (index === parts.length - 1) {
                            li.classList.add('active');
                            li.textContent = part;
                        } else {
                            const link = document.createElement('a');
                            link.href = '#';
                            link.textContent = part;
                            link.addEventListener('click', (e) => {
                                e.preventDefault();
                                loadDirectory(currentPath);
                            });
                            li.appendChild(link);
                        }
                        
                        pathBreadcrumb.appendChild(li);
                        currentPath += '/';
                    });
                }
            }
            
            // Format file size
            function formatFileSize(size) {
                size = parseInt(size);
                if (isNaN(size)) return '';
                
                if (size < 1024) return `${size} B`;
                if (size < 1024 * 1024) return `${(size / 1024).toFixed(1)} KB`;
                if (size < 1024 * 1024 * 1024) return `${(size / (1024 * 1024)).toFixed(1)} MB`;
                return `${(size / (1024 * 1024 * 1024)).toFixed(1)} GB`;
            }
            
            // Show error message
            function showError(message) {
                fileExplorerContent.innerHTML = `
                    <div class="p-4 text-center text-danger">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        <p class="mt-2">${message}</p>
                    </div>
                `;
            }
            
            // Initialize WebSocket connection
            if (typeof initializeWebSocket === 'function') {
                initializeWebSocket();
                
                // Handle file change events
                socket.on('file_change', function(data) {
                    // Reload current directory on file changes
                    loadDirectory(currentDirectory);
                });
            }
        });
    </script>
</body>
</html>