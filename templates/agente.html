{% extends "base.html" %}

{% block title %}Agente de Desarrollo - Codestorm Assistant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tech-selector.css') }}">
<style>
    .card-futuristic {
        background-color: #222;
        color: #eee;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .card-header-futuristic {
        background-color: #333;
        color: #fff;
        border-bottom: 1px solid #444;
        padding: 1rem;
    }

    .futuristic-input {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        border-radius: 5px;
        padding: 0.5rem;
    }

    .futuristic-select {
        background-color: #333;
        color: #eee;
        border: 1px solid #555;
        border-radius: 5px;
    }

    .btn-futuristic {
        background-color: #1E88E5;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.8rem 1.5rem;
        transition: all 0.3s ease;
    }

    .btn-futuristic:hover {
        background-color: #2196F3;
        box-shadow: 0 5px 15px rgba(30, 136, 229, 0.3);
    }

    .btn-outline-primary.btn-futuristic {
        background-color: transparent;
        border: 2px solid #1E88E5;
        color: #1E88E5;
    }

    .btn-outline-primary.btn-futuristic:hover {
        background-color: #1E88E5;
        color: white;
    }

    .btn-outline-secondary.btn-futuristic {
        background-color: transparent;
        border: 2px solid #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary.btn-futuristic:hover {
        background-color: #6c757d;
        color: white;
    }

    .feature-tag {
        display: inline-block;
        background-color: #1E88E5;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        margin: 0.2rem;
        font-size: 0.85rem;
    }

    .feature-tag .remove-tag {
        cursor: pointer;
        margin-left: 5px;
    }

    .console-output {
        background-color: #121212;
        color: #00FF00;
        font-family: monospace;
        padding: 10px;
        border-radius: 5px;
        height: 150px;
        overflow-y: auto;
        margin-top: 15px;
    }

    /* Estilos para las tarjetas de tecnologías */
    .tech-stack-card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .tech-stack-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .tech-stack-card .card-header {
        background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
        color: white;
        border-bottom: none;
    }

    .tech-item {
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .tech-label {
        font-weight: bold;
        min-width: 100px;
    }

    .tech-value {
        font-size: 0.9rem;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .badge.bg-primary {
        background: linear-gradient(135deg, #007bff, #0056b3) !important;
    }


    <!-- Controles de construcción -->
    .constructor-controls {
        margin-top: 30px;
        margin-bottom: 40px;
    }
    .constructor-controls .d-flex {
        justify-content: space-between;
        align-items: center;
    }
    .constructor-controls .controls-left {
        margin-right: 20px;
    }
    .constructor-controls .controls-right {
        margin-left: 20px;
    }
    .constructor-controls .btn {
        margin-right: 5px;
    }
    .constructor-controls .btn.ms-2 {
        margin-left: 10px;
    }

    .badge.bg-success {
        background: linear-gradient(135deg, #28a745, #1e7e34) !important;
    }

    .badge.bg-warning {
        background: linear-gradient(135deg, #ffc107, #d39e00) !important;
    }

    /* Estilos para el Asistente de Chat */
    .chat-float-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
    }

    .chat-float-button button {
        width: 60px;
        height: 60px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }

    .chat-float-button button:hover {
        transform: scale(1.05);
    }

    .chat-float-button button i {
        font-size: 24px;
    }

    .chat-panel {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 380px;
        height: 500px;
        background-color: #222;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        z-index: 9998;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .chat-header {
        background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .chat-input {
        padding: 15px;
        background-color: #333;
        border-top: 1px solid #444;
    }

    .message {
        margin-bottom: 15px;
        max-width: 85%;
        word-wrap: break-word;
    }

    .user-message {
        margin-left: auto;
        background-color: #1E88E5;
        color: white;
        padding: 10px 15px;
        border-radius: 15px 15px 3px 15px;
    }

    .assistant-message {
        margin-right: auto;
        background-color: #424242;
        color: white;
        padding: 10px 15px;
        border-radius: 15px 15px 15px 3px;
    }

    .system-message {
        background-color: #1c1c1c;
        border-left: 3px solid #1E88E5;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 5px;
        font-size: 0.9rem;
    }

    .context-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        background-color: #555;
        border-radius: 10px;
        margin-right: 5px;
        color: #ccc;
    }

    .action-message {
        text-align: center;
        margin: 10px 0;
        font-size: 0.85rem;
        color: #aaa;
    }

    /* Animación para el botón de intervención */
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    .intervention-active {
        animation: pulse 2s infinite;
        background-color: #dc3545 !important;
    }

    /* Indicador de escritura */
    .typing-indicator {
        display: flex;
        padding: 6px 10px;
        background-color: #424242;
        border-radius: 15px;
        margin-bottom: 15px;
        width: fit-content;
    }

    .typing-bubble {
        width: 7px;
        height: 7px;
        margin: 0 1px;
        background-color: #999;
        border-radius: 50%;
        opacity: 0.6;
    }

    .typing-bubble:nth-child(1) {
        animation: typing 1s infinite 0s;
    }
    .typing-bubble:nth-child(2) {
        animation: typing 1s infinite 0.33s;
    }
    .typing-bubble:nth-child(3) {
        animation: typing 1s infinite 0.66s;
    }

    @keyframes typing {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card card-futuristic">
                <div class="card-header card-header-futuristic">
                    <i class="bi bi-code-slash me-2"></i> Agente de Desarrollo con IA
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i> El Agente de Desarrollo utiliza agentes especializados para generar tu aplicación completa basada en tu descripción y stack tecnológico seleccionado.
                    </div>

                    <!-- Selector de Tecnologías -->
                    <div id="tech-selector-container">
                        <div class="tech-selector-header">
                            <h3>Plan de Desarrollo <i class="bi bi-check2-circle"></i></h3>
                            <p>Selecciona el stack tecnológico que prefieres para tu aplicación</p>
                        </div>

                        <div class="tech-selector-nav">
                            <ul class="nav nav-pills nav-fill" id="techSelectorTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="presets-tab" data-bs-toggle="pill" data-bs-target="#presets-content" type="button" role="tab">
                                        <i class="bi bi-lightning-charge me-1"></i> Plantillas
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="backend-tab" data-bs-toggle="pill" data-bs-target="#backend-content" type="button" role="tab">
                                        <i class="bi bi-server me-1"></i> Backend
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="frontend-tab" data-bs-toggle="pill" data-bs-target="#frontend-content" type="button" role="tab">
                                        <i class="bi bi-layout-wtf me-1"></i> Frontend
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="database-tab" data-bs-toggle="pill" data-bs-target="#database-content" type="button" role="tab">
                                        <i class="bi bi-database me-1"></i> Base de Datos
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="features-tab" data-bs-toggle="pill" data-bs-target="#features-content" type="button" role="tab">
                                        <i class="bi bi-puzzle me-1"></i> Características
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <div class="tab-content tech-selector-tab-content" id="techSelectorContent">
                            <!-- Plantillas Predefinidas -->
                            <div class="tab-pane fade show active" id="presets-content" role="tabpanel">
                                <h5>Plantillas de Stack Tecnológico</h5>
                                <p class="text-muted mb-4">Selecciona una plantilla predefinida o personaliza tu stack manualmente en las otras pestañas</p>

                                <div class="row" id="preset-stacks">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Backend -->
                            <div class="tab-pane fade" id="backend-content" role="tabpanel">
                                <h5>Selecciona tu Backend</h5>
                                <p class="text-muted mb-4">El backend es responsable de la lógica de negocio y el procesamiento de datos</p>

                                <div id="backend-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Frontend -->
                            <div class="tab-pane fade" id="frontend-content" role="tabpanel">
                                <h5>Selecciona tu Frontend</h5>
                                <p class="text-muted mb-4">El frontend es la interfaz que verán tus usuarios</p>

                                <div id="frontend-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Base de Datos -->
                            <div class="tab-pane fade" id="database-content" role="tabpanel">
                                <h5>Selecciona tu Base de Datos</h5>
                                <p class="text-muted mb-4">La base de datos almacenará la información de tu aplicación</p>

                                <div id="database-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>

                            <!-- Características Adicionales -->
                            <div class="tab-pane fade" id="features-content" role="tabpanel">
                                <h5>Características Adicionales</h5>
                                <p class="text-muted mb-4">Selecciona las características que requiere tu proyecto</p>

                                <div class="row" id="features-options">
                                    <!-- El contenido se generará dinámicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de selección -->
                        <div class="stack-summary" id="tech-selection-summary">
                            <!-- El contenido se generará dinámicamente -->
                        </div>

                        <div class="compatibility-notice">
                            <h6><i class="bi bi-info-circle me-1"></i> Consejo de compatibilidad</h6>
                            <p>Algunas combinaciones de tecnologías funcionan mejor juntas. Las plantillas predefinidas ofrecen la mejor compatibilidad garantizada.</p>
                        </div>

                        <div class="tech-selector-footer">
                            <button type="button" id="tech-selection-continue" class="btn btn-lg btn-primary btn-futuristic" disabled>
                                <i class="bi bi-arrow-right me-2"></i> Continuar al desarrollo
                            </button>
                        </div>
                    </div>

                    <!-- Formulario de Construcción (inicialmente oculto) -->
                    <div id="constructor-container" style="display: none;">
                        <h4 class="mb-4">Detalles del Proyecto</h4>

                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">Stack Tecnológico Seleccionado</h5>
                                        <div id="selected-tech-summary"></div>
                                        <div id="selected-features" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-primary h-100 d-flex align-items-center">
                                    <div>
                                        <h5 class="alert-heading"><i class="bi bi-lightning-charge"></i> ¡Excelente elección!</h5>
                                        <p class="mb-0">Completa la descripción para generar tu aplicación con estas tecnologías.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form id="constructor-form">
                            <input type="hidden" id="project-tech-data" name="tech_data" value="">
                        <div class="mb-4">
                            <label for="project-description" class="form-label">Describe tu aplicación</label>
                            <textarea id="project-description" class="form-control futuristic-input" rows="5" 
                                placeholder="Describe en detalle la aplicación que deseas crear. Por ejemplo: 'Una aplicación para gestionar inventario con login, dashboard y reportes en PDF'"></textarea>
                        </div>

                        <!-- Características detectadas -->
                        <div class="mb-3" id="features-container" style="display: none;">
                            <label class="form-label">Características detectadas:</label>
                            <div id="features-tags" class="mb-2"></div>
                            <div class="form-text">Estas características se han detectado automáticamente. Puedes eliminar las que no desees.</div>
                        </div>

                        <!-- Selección de Agente -->
                        <div class="mb-3">
                            <label class="form-label">Selecciona el Agente Especializado:</label>
                            <select id="agent-selector" class="form-select form-select-sm futuristic-select">
                                <option value="developer" selected>Desarrollador de Código</option>
                                <option value="architect">Arquitecto de Software</option>
                                <option value="advanced">Experto Avanzado</option>
                                <option value="general">Asistente General</option>
                            </select>
                            <div class="form-text">El agente determina el enfoque para la generación de tu aplicación</div>
                        </div>

                        <!-- Selección de Modelo de IA -->
                        <div class="mb-3">
                            <label class="form-label">Selecciona el Modelo de IA:</label>
                            <select id="model-selector" class="form-select form-select-sm futuristic-select">
                                <option value="openai" selected>OpenAI (GPT-4o)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                            </select>
                            <div id="api-status" class="mt-2 small text-info">Verificando disponibilidad de modelos...</div>
                            <div class="form-text">Diferentes modelos pueden tener distintas capacidades</div>
                        </div>

                        <!-- Opciones Adicionales -->
                        <div class="mb-4">
                            <label class="form-label">Opciones Adicionales:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-tests" checked>
                                <label class="form-check-label" for="include-tests">Incluir pruebas automatizadas</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-docs" checked>
                                <label class="form-check-label" for="include-docs">Generar documentación</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-deployment" checked>
                                <label class="form-check-label" for="include-deployment">Configuración para despliegue</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-ci-cd">
                                <label class="form-check-label" for="include-ci-cd">Configurar CI/CD</label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-futuristic" id="generate-btn">
                                <i class="bi bi-stars me-2"></i> Generar Aplicación
                            </button>
                        </div>
                    </form>

                    <!-- Indicador de Progreso (oculto inicialmente) -->
                    <div id="generation-progress" class="mt-4" style="display: none;">
                        <h5>Generando tu aplicación...</h5>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <p id="progress-text">0% completado</p>
                        <p id="current-stage">Inicializando agentes...</p>
                        <div id="framework-info" class="mt-3 d-none">
                            <div class="card tech-stack-card">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0">Stack Tecnológico</h5>
                                </div>
                                <div class="card-body">
                                    <h6 id="framework-name" class="card-title">No seleccionado</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="tech-item">
                                                <span class="tech-label">Backend:</span>
                                                <span id="backend-tech" class="tech-value badge bg-primary">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="tech-item">
                                                <span class="tech-label">Frontend:</span>
                                                <span id="frontend-tech" class="tech-value badge bg-success">-</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="tech-item">
                                                <span class="tech-label">Base de datos:</span>
                                                <span id="database-tech" class="tech-value badge bg-warning text-dark">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Controles de desarrollo -->
                        <div class="mt-3 mb-3 text-center">
                            <button id="pause-development-btn" class="btn btn-warning btn-sm me-2">
                                <i class="bi bi-pause-fill me-1"></i> Pausar Desarrollo
                            </button>
                            <button id="resume-development-btn" class="btn btn-success btn-sm" style="display: none;">
                                <i class="bi bi-play-fill me-1"></i> Reanudar Desarrollo
                            </button>
                        </div>

                        <div class="console-output" id="generation-console"></div>
                    </div>

                    <!-- Resultado (oculto inicialmente) -->
                    <div id="generation-result" class="mt-4" style="display: none;">
                        <div id="result-message" class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i> ¡Tu aplicación ha sido generada exitosamente!
                        </div>
                        <div class="d-grid gap-2">
                            <button id="view-app-btn" class="btn btn-outline-primary btn-futuristic">
                                <i class="bi bi-eye me-2"></i> Ver Aplicación
                            </button>
                            <button id="download-app-btn" class="btn btn-outline-secondary btn-futuristic">
                                <i class="bi bi-download me-2"></i> Descargar Código
                            </button>
                        </div>
                    </div>
                    <div id="message-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón Flotante del Asistente -->
<div id="assistant-chat-button" class="chat-float-button">
    <button class="btn btn-primary rounded-circle" id="toggle-assistant-chat">
        <i class="bi bi-chat-dots-fill"></i>
    </button>
</div>

<!-- Panel del Asistente de Chat -->
<div id="assistant-chat-panel" class="chat-panel" style="display: none;">
    <div class="chat-header">
        <h5><i class="bi bi-robot"></i> Asistente de Desarrollo</h5>
        <button id="close-assistant-chat" class="btn-close btn-close-white"></button>
    </div>
    <div class="chat-body" id="assistant-chat-messages">
        <div class="system-message">
            <p>¡Hola! Soy tu asistente de desarrollo. Puedo ayudarte a modificar tu proyecto durante su construcción.</p>
            <p>Algunos ejemplos de lo que puedo hacer:</p>
            <ul>
                <li>Añadir nuevas funcionalidades</li>
                <li>Crear archivos de configuración</li>
                <li>Modificar el diseño</li>
                <li>Ajustar parámetros técnicos</li>
            </ul>
        </div>
    </div>
    <div class="chat-input">
        <div class="input-group">
            <input type="text" id="assistant-chat-input" class="form-control futuristic-input" 
                   placeholder="Describe los cambios que necesitas...">
            <button class="btn btn-primary" id="send-assistant-message">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
        <div class="chat-context mt-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="intervention-mode" checked>
                <label class="form-check-label small" for="intervention-mode">Modo intervención</label>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tech-selector.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat/code-formatter.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const constructorForm = document.getElementById('constructor-form');
    const generateBtn = document.getElementById('generate-btn');
    const progressSection = document.getElementById('generation-progress');
    const resultSection = document.getElementById('generation-result');
    const progressBar = document.getElementById('progress-bar');
    const currentStage = document.getElementById('current-stage');
    const progressText = document.getElementById('progress-text'); 
    const viewAppBtn = document.getElementById('view-app-btn');
    const downloadAppBtn = document.getElementById('download-app-btn');
    const projectDescription = document.getElementById('project-description');
    const featuresContainer = document.getElementById('features-container');
    const featuresTags = document.getElementById('features-tags');
    const generationConsole = document.getElementById('generation-console');

    // Variable para almacenar el ID del proyecto
    let projectId = null;

    // Verificar disponibilidad de APIs
    checkAPIAvailability();

    // Evento para analizar características al escribir descripción
    let debounceTimer;
    projectDescription.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
            const description = projectDescription.value.trim();
            if (description.length > 30) {
                analyzeFeatures(description);
            }
        }, 1000);
    });

    // Función para analizar y extraer características de la descripción
    function analyzeFeatures(description) {
        fetch('/api/constructor/analyze-features', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ description: description }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.features && data.features.length > 0) {
                displayFeatures(data.features);
                featuresContainer.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error al analizar características:', error);
        });
    }

    // Función para mostrar características detectadas
    function displayFeatures(features) {
        featuresTags.innerHTML = '';
        features.forEach(feature => {
            const tag = document.createElement('span');
            tag.className = 'feature-tag';
            tag.innerHTML = feature + ' <span class="remove-tag">×</span>';

            tag.querySelector('.remove-tag').addEventListener('click', function() {
                tag.remove();
            });

            featuresTags.appendChild(tag);
        });
    }

    // Función para recopilar características seleccionadas
    function getSelectedFeatures() {
        const tags = featuresTags.querySelectorAll('.feature-tag');
        return Array.from(tags).map(tag => tag.textContent.replace('×', '').trim());
    }

    // Función para verificar disponibilidad de APIs
    function checkAPIAvailability() {
        fetch('/api/health')
            .then(response => response.json())
            .then(data => {
                const apiStatus = document.getElementById('api-status');
                if (apiStatus) {
                    const apis = data.apis || {};
                    const availableApis = Object.entries(apis)
                        .filter(([_, status]) => status === 'ok')
                        .map(([name, _]) => name);

                    if (availableApis.length > 0) {
                        apiStatus.textContent = 'APIs disponibles: ' + availableApis.join(', ');
                        apiStatus.className = 'mt-2 small text-success';

                        // Actualizar el selector de modelos
                        const modelSelector = document.getElementById('model-selector');
                        if (modelSelector) {
                            // Deshabilitar opciones no disponibles
                            Array.from(modelSelector.options).forEach(option => {
                                const isAvailable = apis[option.value] === 'ok';
                                option.disabled = !isAvailable;
                                if (!isAvailable) {
                                    option.textContent += ' (no configurado)';
                                }
                            });

                            // Seleccionar el primer modelo disponible
                            const firstAvailable = Array.from(modelSelector.options)
                                .find(option => !option.disabled);
                            if (firstAvailable) {
                                firstAvailable.selected = true;
                            }
                        }
                    } else {
                        apiStatus.textContent = 'No hay APIs configuradas. Configura al menos una en el panel de Secrets.';
                        apiStatus.className = 'mt-2 small text-warning';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking API availability:', error);
                const apiStatus = document.getElementById('api-status');
                if (apiStatus) {
                    apiStatus.textContent = 'Error al verificar disponibilidad de APIs';
                    apiStatus.className = 'mt-2 small text-danger';
                }
            });
    }

    // Agregar mensaje al console log de generación
    function addConsoleMessage(message, type = 'info') {
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

        if (type === 'error') {
            line.style.color = '#FF5252';
        } else if (type === 'success') {
            line.style.color = '#00E676';
        } else {
            line.style.color = '#00FF00';
        }

        generationConsole.appendChild(line);
        generationConsole.scrollTop = generationConsole.scrollHeight;
    }

    // Configurar interval para verificar el estado del proyecto
    let statusCheckInterval;
    function startStatusCheck(projectId) {
        statusCheckInterval = setInterval(() => {
            fetch(`/api/constructor/status/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProjectStatus(data); 

                        if (data.status === 'completed') {
                            clearInterval(statusCheckInterval);
                            showCompletedState(projectId);
                        } else if (data.status === 'failed') {
                            clearInterval(statusCheckInterval);
                            showFailedState(data.error);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al verificar estado:', error);
                    addConsoleMessage('Error al verificar estado del proyecto', 'error');
                });
        }, 2000);
    }

    // Mostrar estado de generación completada
    function showCompletedState(projectId) {
        setTimeout(() => {
            progressSection.style.display = 'none';
            resultSection.style.display = 'block';
            generateBtn.disabled = false;

            // Configurar botones con el ID del proyecto
            downloadAppBtn.setAttribute('data-project-id', projectId);
            viewAppBtn.setAttribute('data-project-id', projectId);
        }, 1000);
    }

    // Mostrar estado de error
    function showFailedState(error) {
        progressBar.className = 'progress-bar bg-danger';
        currentStage.textContent = 'Error: ' + (error || 'Ha ocurrido un problema durante la generación');
        addConsoleMessage('Error en la generación: ' + (error || 'Error desconocido'), 'error');
        generateBtn.disabled = false;
    }


    // Evento de envío del formulario
    constructorForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Obtener valores del formulario
        const description = projectDescription.value.trim();
        const agent = document.getElementById('agent-selector').value;
        const model = document.getElementById('model-selector').value;
        const includeTests = document.getElementById('include-tests').checked;
        const includeDocs = document.getElementById('include-docs').checked;
        const includeDeployment = document.getElementById('include-deployment').checked;
        const includeCICD = document.getElementById('include-ci-cd').checked;
        const features = getSelectedFeatures();

        if (!description) {
            alert('Por favor, describe tu aplicación');
            return;
        }

        // Mostrar sección de progreso
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';
        generateBtn.disabled = true;
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        progressBar.textContent = '0%';
        generationConsole.innerHTML = '';

        // Iniciar generación del proyecto
        fetch('/api/constructor/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                agent: agent,
                model: model,
                options: {
                    includeTests,
                    includeDocs,
                    includeDeployment,
                    includeCICD
                },
                features: features
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                projectId = data.project_id;
                addConsoleMessage(`Proyecto iniciado con ID: ${projectId}`);
                addConsoleMessage(`Tiempo estimado: ${data.estimated_time}`);
                startStatusCheck(projectId);

                // Actualizar progreso inicial
                progressBar.style.width = '5%';
                progressBar.setAttribute('aria-valuenow', 5);
                progressBar.textContent = '5%';
            } else {
                showFailedState(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFailedState(error.message);
        });
    });

    // Evento de descarga del proyecto
    downloadAppBtn.addEventListener('click', function() {
        const projectId = this.getAttribute('data-project-id');
        if (!projectId) {
            alert('ID de proyecto no disponible');
            return;
        }

        downloadProject(projectId);
    });

    // Evento para ver la aplicación
    viewAppBtn.addEventListener('click', function() {
        const projectId = this.getAttribute('data-project-id');
        if (!projectId) {
            alert('ID de proyecto no disponible');
            return;
        }

        window.open(`/api/constructor/preview/${projectId}`, '_blank');
    });

    // Manejar pausa del desarrollo
    const pauseDevelopmentBtn = document.getElementById('pause-development-btn');
    const resumeDevelopmentBtn = document.getElementById('resume-development-btn');

    pauseDevelopmentBtn.addEventListener('click', function() {
        if (!projectId) {
            alert('No hay proyecto en desarrollo');
            return;
        }

        fetch(`/api/constructor/pause/${projectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addConsoleMessage('Desarrollo pausado por el usuario', 'info');
                pauseDevelopmentBtn.style.display = 'none';
                resumeDevelopmentBtn.style.display = 'inline-block';

                // Cambiar el estilo de la barra de progreso
                progressBar.classList.remove('progress-bar-animated');
            } else {
                addConsoleMessage('Error al pausar el desarrollo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error al pausar desarrollo:', error);
            addConsoleMessage('Error al pausar el desarrollo', 'error');
        });
    });

    // Manejar reanudación del desarrollo
    resumeDevelopmentBtn.addEventListener('click', function() {
        if (!projectId) {
            alert('No hay proyecto en desarrollo');
            return;
        }

        fetch(`/api/constructor/resume/${projectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addConsoleMessage('Desarrollo reanudado por el usuario', 'success');
                resumeDevelopmentBtn.style.display = 'none';
                pauseDevelopmentBtn.style.display = 'inline-block';

                // Restaurar el estilo de la barra de progreso
                progressBar.classList.add('progress-bar-animated');
            } else {
                addConsoleMessage('Error al reanudar el desarrollo: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error al reanudar desarrollo:', error);
            addConsoleMessage('Error al reanudar el desarrollo', 'error');
        });
    });

    // Función para actualizar el estado del proyecto, incluyendo la información del framework
    function updateProjectStatus(data) {
        if (!projectId) return;

        // Actualizar barra de progreso
        const progress = data.progress || 0;
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = `${progress}% completado`;

        // Actualizar etapa actual
        currentStage.textContent = data.current_stage || 'Procesando...';

        // Actualizar mensaje de consola si hay uno nuevo
        if (data.console_message) {
            addConsoleMessage(data.console_message);
        }

        // Actualizar información del framework si está disponible
        if (data.framework) {
            const frameworkInfo = document.getElementById('framework-info');
            frameworkInfo.classList.remove('d-none');

            document.getElementById('framework-name').textContent = data.framework;

            if (data.techstack) {
                if (data.techstack.backend) {
                    document.getElementById('backend-tech').textContent = capitalizeFirstLetter(data.techstack.backend);
                }

                if (data.techstack.frontend) {
                    document.getElementById('frontend-tech').textContent = capitalizeFirstLetter(data.techstack.frontend);
                }

                if (data.techstack.database) {
                    document.getElementById('database-tech').textContent = capitalizeFirstLetter(data.techstack.database);
                }
            }
        }

        // Si está completado, habilitar botón de descarga
        if (data.status === 'completed') {
            downloadAppBtn.disabled = false;
            downloadAppBtn.classList.remove('btn-secondary');
            downloadAppBtn.classList.add('btn-success');
            downloadAppBtn.innerHTML = '<i class="bi bi-download"></i> Descargar Proyecto';

            // Detener el polling cuando está completo
            clearInterval(statusCheckInterval);

            // Quitar animación de la barra de progreso
            progressBar.classList.remove('progress-bar-animated');

            // Ocultar botón de pausar
            pauseDevelopmentBtn.style.display = 'none';
            resumeDevelopmentBtn.style.display = 'none';
        }

        // Si hay un error, mostrar
        if (data.error) {
            addConsoleMessage('Error: ' + data.error, 'error');
        }

        // Si está pausado, mostrar el botón de reanudar
        if (data.current_stage && data.current_stage.includes("(PAUSADO)")) {
            pauseDevelopmentBtn.style.display = 'none';
            resumeDevelopmentBtn.style.display = 'inline-block';

            // Quitar animación de la barra de progreso
            progressBar.classList.remove('progress-bar-animated');
        }
    }


    // Función de utilidad para capitalizar
    function capitalizeFirstLetter(string) {
        if (!string) return '';
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // Función para descargar el proyecto
    function downloadProject(projectId) {
        // Mostrar mensaje de descarga iniciada
        showMessage('Preparando descarga...', 'info');

        // Realizar una verificación previa
        fetch(`/api/constructor/status/${projectId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.status === 'completed') {
                    // Iniciar descarga directa
                    window.location.href = `/api/constructor/download/${projectId}`;

                    // Mostrar mensaje después de iniciar descarga
                    setTimeout(() => {
                        showMessage('Si la descarga no comenzó automáticamente, <a href="/api/constructor/download/' + 
                                  projectId + '" class="download-link">haz clic aquí</a>', 'success');
                    }, 3000);
                } else {
                    // Si el proyecto no está completado, mostrar mensaje
                    showMessage('El proyecto aún no está listo para descargar. Estado: ' + 
                              (data.status || 'desconocido'), 'warning');
                }
            })
            .catch(error => {
                console.error('Error verificando estado:', error);
                // Intentar descarga directa como fallback
                window.location.href = `/api/constructor/download/${projectId}`;

                // Mostrar mensaje de fallback
                setTimeout(() => {
                    showMessage('Intentando descarga directa. Si no funciona, por favor inténtalo más tarde o contacta con soporte.', 'warning');
                }, 2000);
            });
    }

    // Función para mostrar mensajes en la interfaz
    function showMessage(message, type) {
        const messageContainer = document.getElementById('message-container');
        if (!messageContainer) {
            // Crear contenedor de mensajes si no existe
            const container = document.createElement('div');
            container.id = 'message-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '1000';
            document.body.appendChild(container);
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.innerHTML = message;
        messageDiv.style.marginBottom = '10px';
        messageDiv.style.minWidth = '300px';

        document.getElementById('message-container').appendChild(messageDiv);

        // Auto-eliminar después de 8 segundos
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 8000);
    }

    // Funcionalidad del Asistente de Chat
    const toggleChatButton = document.getElementById('toggle-assistant-chat');
    const closeChatButton = document.getElementById('close-assistant-chat');
    const chatPanel = document.getElementById('assistant-chat-panel');
    const chatInput = document.getElementById('assistant-chat-input');
    const sendMessageButton = document.getElementById('send-assistant-message');
    const chatMessages = document.getElementById('assistant-chat-messages');
    const interventionModeToggle = document.getElementById('intervention-mode');

    // Manejar eventos de apertura/cierre del chat
    toggleChatButton.addEventListener('click', function() {
        chatPanel.style.display = chatPanel.style.display === 'none' ? 'flex' : 'none';
        if (chatPanel.style.display === 'flex') {
            chatInput.focus();
        }
    });

    closeChatButton.addEventListener('click', function() {
        chatPanel.style.display = 'none';
    });

    // Manejar envío de mensajes (con Enter o click en botón)
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && chatInput.value.trim()) {
            sendMessage();
        }
    });

    sendMessageButton.addEventListener('click', function() {
        if (chatInput.value.trim()) {
            sendMessage();
        }
    });

    // Función para manejar el modo intervención
    interventionModeToggle.addEventListener('change', function() {
        if (this.checked) {
            toggleChatButton.classList.add('intervention-active');
            // Notificar que estamos en modo intervención
            if (projectId) {
                notifyProjectIntervention(projectId, true);
            }
        } else {
            toggleChatButton.classList.remove('intervention-active');
            // Notificar que salimos del modo intervención
            if (projectId) {
                notifyProjectIntervention(projectId, false);
            }
        }
    });

    // Función para enviar mensajes al asistente
    function sendMessage() {
        const userMessage = chatInput.value.trim();

        // Agregar mensaje del usuario a la interfaz
        addMessage(userMessage, 'user');
        chatInput.value = '';

        // Mostrar indicador de escritura
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        for (let i = 0; i < 3; i++) {
            const bubble = document.createElement('div');
            bubble.className = 'typing-bubble';
            typingIndicator.appendChild(bubble);
        }
        chatMessages.appendChild(typingIndicator);

        // Desplazarse al final
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Determinar el contexto de la solicitud
        const isInterventionMode = interventionModeToggle.checked;
        const context = {
            projectId: projectId || null,
            mode: isInterventionMode ? 'intervention' : 'information',
            currentStage: document.getElementById('current-stage')?.textContent || 'No iniciado',
            progress: document.getElementById('progress-bar')?.getAttribute('aria-valuenow') || 0
        };

        // Llamar a la API para procesar el mensaje
        fetch('/api/assistant/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: userMessage,
                context: context
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remover indicador de escritura
            if (typingIndicator && typingIndicator.parentNode) {
                typingIndicator.parentNode.removeChild(typingIndicator);
            }

            // Procesar respuesta
            if (data.success) {
                // Agregar la respuesta del asistente
                addMessage(data.response, 'assistant');

                // Si hay acciones a realizar, procesarlas
                if (data.actions && data.actions.length > 0) {
                    processAssistantActions(data.actions);
                }
            } else {
                // Manejar error
                addMessage('Lo siento, hubo un problema al procesar tu mensaje: ' + 
                          (data.error || 'Error desconocido'), 'system');
            }
        })
        .catch(error => {
            console.error('Error en la comunicación con el asistente:', error);

            // Remover indicador de escritura
            if (typingIndicator && typingIndicator.parentNode) {
                typingIndicator.parentNode.removeChild(typingIndicator);
            }

            // Mostrar mensaje de error
            addMessage('No pude conectarme con el servidor. Por favor, intenta nuevamente más tarde.', 'system');
        });
    }

    // Función para añadir mensajes a la interfaz
    function addMessage(message, type) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message ' + (type === 'user' ? 'user-message' : 
                                              type === 'assistant' ? 'assistant-message' : 'system-message');

        // Formatear mensajes según su tipo
        if (type === 'assistant' && message.includes('```')) {
            // Formatear bloques de código
            let formattedMessage = '';
            const parts = message.split(/```(\w*)\n([\s\S]*?)```/g);

            for (let i = 0; i < parts.length; i++) {
                if (i % 3 === 0) {
                    // Texto regular - Conservar saltos de línea
                    const textWithLineBreaks = parts[i].replace(/\n/g, '<br>');
                    formattedMessage += `<p>${textWithLineBreaks}</p>`;
                } else if (i % 3 === 1) {
                    // Lenguaje de programación (lo guardamos para el siguiente bloque)
                    continue;
                } else {
                    // Código con lenguaje específico
                    const language = parts[i-1] || 'plaintext';
                    formattedMessage += `<div class="code-block">
                        <div class="code-header">${language}</div>
                        <pre><code class="language-${language}">${parts[i]}</code></pre>
                    </div>`;
                }
            }
            messageElement.innerHTML = formattedMessage;
        } else {
            // Mensaje regular - Para mensajes normales usamos innerHTML para preservar los saltos de línea
            const textWithLineBreaks = message.replace(/\n/g, '<br>');
            messageElement.innerHTML = textWithLineBreaks;
        }

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Función para notificar sobre la intervención en un proyecto
    function notifyProjectIntervention(projectId, isIntervening) {
        fetch('/api/assistant/intervention-mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                project_id: projectId,
                is_intervening: isIntervening
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (isIntervening) {
                    addMessage('Modo intervención activado. Puedo modificar el proyecto en desarrollo.', 'system');
                } else {
                    addMessage('Modo intervención desactivado. Ahora solo puedo proporcionarte información.', 'system');
                }
            } else {
                console.error('Error al cambiar modo intervención:', data.error);
            }
        })
        .catch(error => {
            console.error('Error de comunicación:', error);
        });
    }

    // Función para procesar acciones solicitadas por el asistente
    function processAssistantActions(actions) {
        actions.forEach(action => {
            switch (action.type) {
                case 'add_file':
                    addActionMessage(`Añadiendo archivo: ${action.filename}`);
                    break;
                case 'modify_file':
                    addActionMessage(`Modificando archivo: ${action.filename}`);
                    break;
                case 'add_feature':
                    addActionMessage(`Añadiendo característica: ${action.feature}`);
                    break;
                case 'modify_config':
                    addActionMessage(`Modificando configuración: ${action.config_name}`);
                    break;
                case 'restart_stage':
                    addActionMessage(`Reiniciando etapa: ${action.stage_name}`);
                    break;
                case 'notification':
                    addConsoleMessage(action.message, action.level || 'info');
                    break;
            }

            // Ejecutar la acción en el proyecto
            executeAssistantAction(action);
        });
    }

    // Añadir un mensaje de acción en el chat
    function addActionMessage(message) {
        const actionElement = document.createElement('div');
        actionElement.className = 'action-message';
        actionElement.innerHTML = `<i class="bi bi-gear-fill me-1"></i> ${message}`;
        chatMessages.appendChild(actionElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Ejecutar la acción solicitada por el asistente
    function executeAssistantAction(action) {
        if (!projectId) {
            console.error('No hay un proyecto activo para ejecutar la acción');
            return;
        }

        fetch('/api/assistant/execute-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                project_id: projectId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addActionMessage(`✅ Acción completada: ${data.message || ''}`);

                // Actualizar interfaz si es necesario
                if (action.update_ui) {
                    updateUIAfterAction(action, data);
                }

                // Si hay cambio en el progreso, actualizar
                if (data.new_progress) {
                    updateProgress(data.new_progress);
                }
            } else {
                addActionMessage(`❌ Error en acción: ${data.error || 'Error desconocido'}`);
            }
        })
        .catch(error => {
            console.error('Error al ejecutar acción:', error);
            addActionMessage(`❌ Error de comunicación al ejecutar acción`);
        });
    }

    // Actualizar la interfaz después de una acción
    function updateUIAfterAction(action, responseData) {
        // Esta función se puede ampliar según las necesidades específicas
        // Por ejemplo, actualizar la lista de características si se añadió una
        if (action.type === 'add_feature' && featuresTags) {
            const tag = document.createElement('span');
            tag.className = 'feature-tag';
            tag.innerHTML = action.feature + ' <span class="remove-tag">×</span>';

            tag.querySelector('.remove-tag').addEventListener('click', function() {
                tag.remove();
            });

            featuresTags.appendChild(tag);
            featuresContainer.style.display = 'block';
        }

        // Actualizar la consola con información relevante
        if (action.console_message && generationConsole) {
            addConsoleMessage(action.console_message, action.level || 'info');
        }
    }

    // Actualizar el progreso después de una acción
    function updateProgress(newProgress) {
        if (progressBar) {
            progressBar.style.width = `${newProgress}%`;
            progressBar.setAttribute('aria-valuenow', newProgress);
            progressBar.textContent = `${newProgress}%`;

            if (progressText) {
                progressText.textContent = `${newProgress}% completado`;
            }
        }
    }
});
</script>
{% endblock %}

